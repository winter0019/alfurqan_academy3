{% extends 'layout.html' %}
{% block content %}
<div class="max-w-lg mx-auto bg-white p-6 rounded shadow">
    <h2 class="text-xl font-bold mb-4">Record Payment</h2>
    <form method="POST">
        <input type="text" id="student-search" placeholder="Search student by name or reg number"
            class="w-full border p-2 mb-3 rounded">
        <ul id="search-results" class="border rounded mb-3 hidden"></ul>
        <input type="hidden" name="student_id" id="student_id">

        <div id="student-info" class="mb-4 hidden p-3 border rounded-md bg-gray-50">
            <p><strong>Student:</strong> <span id="student-name"></span></p>
            <p><strong>Class:</strong> <span id="student-class"></span></p>
        </div>

        <div class="mb-4 p-3 border rounded-md bg-gray-50">
            <label for="outstanding_balance_input" class="block text-sm font-bold text-gray-700">
                Remaining Balance to Show on Receipt (₦)
            </label>
            <input type="number" step="0.01" name="outstanding_balance_input" id="outstanding_balance_input"
                placeholder="e.g. 50000.00"
                class="w-full border p-2 mt-1 rounded" required>
        </div>

        <input type="number" step="0.01" name="amount_paid" placeholder="Amount Paid (₦)"
            class="w-full border p-2 mb-3 rounded" required>
        <input type="text" name="payment_type" placeholder="Payment Type"
            class="w-full border p-2 mb-3 rounded" required>

        <select name="term" id="term-select" class="w-full border p-2 mb-3 rounded" required>
            <option value="">Select Term</option>
            <option value="1st Term">1st Term</option>
            <option value="2nd Term">2nd Term</option>
            <option value="3rd Term">3rd Term</option>
        </select>

        <input type="text" name="session" id="session-input" placeholder="Session (e.g. 2024/2025)"
            class="w-full border p-2 mb-3 rounded" required>

        <button type="submit" class="w-full bg-green-600 text-white py-2 rounded">Save Payment</button>
    </form>
</div>

<script>
    // FIX 2: ONLY KEEPING THE STUDENT SEARCH LOGIC
    const searchInput = document.getElementById("student-search");
    const resultsList = document.getElementById("search-results");
    const hiddenId = document.getElementById("student_id");
    const studentInfoDiv = document.getElementById("student-info");
    const studentNameSpan = document.getElementById("student-name");
    const studentClassSpan = document.getElementById("student-class");

    searchInput.addEventListener("input", async function() {
        const q = this.value;
        if (q.length < 2) {
            resultsList.innerHTML = "";
            resultsList.classList.add("hidden");
            studentInfoDiv.classList.add("hidden");
            return;
        }

        const res = await fetch(`/search-students?q=${q}`);
        const data = await res.json();

        resultsList.innerHTML = "";
        if (data.students.length > 0) {
            resultsList.classList.remove("hidden");
            data.students.forEach(s => {
                const li = document.createElement("li");
                li.textContent = `${s.name} (${s.reg_number})`;
                li.className = "p-2 hover:bg-gray-100 cursor-pointer";
                li.onclick = () => {
                    searchInput.value = `${s.name} (${s.reg_number})`;
                    
                    hiddenId.value = s.id;
                    studentNameSpan.textContent = `${s.name} (${s.reg_number})`;
                    studentClassSpan.textContent = s.student_class; 
                    
                    resultsList.classList.add("hidden");
                    studentInfoDiv.classList.remove("hidden");
                    
                    // Calculation/AJAX logic is removed, only student details are updated.
                };
                resultsList.appendChild(li);
            });
        } else {
            resultsList.classList.add("hidden");
            studentInfoDiv.classList.add("hidden");
        }
    });
    
    // NOTE: Listeners for Term and Session change (getFinancials) have been removed.
</script>
{% endblock %}
